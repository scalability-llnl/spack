# TODO: 
#  - alinux2 image builder
#  - graviton2 large/medium instance
#  - ADDED expand packages to full set (currently only building 3 packages)
#  - handle parallelcluster provided packages (build a docker AMI based on pcluster)

spack:
  view: false
  concretization: separately

  config:
    install_tree:
      root: /home/software/spack
      padded_length: 512
      projections:
        all: '{architecture}/{compiler.name}-{compiler.version}/{name}-{version}-{hash}'

  packages:
    all:
      target: [graviton2]

      providers:
        mpi: [openmpi, mpich]
    libevent:
      version: 
        - 2.1.8
    libfabric:
      version:
        - 1.12.1
      variants: fabrics=efa,tcp,udp,sockets,verbs,shm,mrail,rxd,rxm
    m4:
      version:
        - 1.4.18
    mpich:
      variants: ~wrapperrpath pmi=pmi netmod=ofi device=ch4
    munge:
      variants: localstatedir=/var
    openmpi:
      variants: +pmi +internal-hwloc fabrics=ofi schedulers=slurm
      version:
        - 4.1.0
    perl:
      version:
        - 5.32.1
    slurm:
      variants: +pmix sysconfdir=/opt/slurm/etc

  definitions:
  # - compilers: 
  #   - '%gcc@10.3.0'
    # - '%arm@21.0.0.879'
    # - '%nvhpc@21.2'
    - when: arch.satisfies('os=ubuntu18.04')
      compilers: ['%gcc@7.5.0']
    - when: arch.satisfies('os=amzn2')
      compilers: ['%gcc@7.3.1']
    - bootstrap-compilers:
      - 'gcc@10.3.0'
    # - 'nvhpc@21.2'
    # - 'arm@21.0.0.879'

    # Note skipping spot since no spack package for it
    - ahug_miniapps:
      - cloverleaf
      - coevp
      - cohmm
    # - examinimd
      - exampm
      - exasp2
      - gamess-ri-mp2-miniapp
      - hpcg
      - laghos
      - lulesh
    # - miniaero
      - miniamr
      - minife
      - minighost
    # fails due to x86 specific timer (asm instructions)
    # - minigmg
      - minimd
      - miniqmc
      - minismac2d
      - minitri
      - minivite
      - minixyce
      - pennant
      - picsarlite
      - quicksilver
      - remhos
      - rsbench
      - simplemoc
      - snap
      - snappy
      - tealeaf
      - thornado-mini
      - tycho2
      - xsbench 

    - ahug_fullapps:
      - abinit
      - abyss
    # conflicts on trilinos
    # - albany
      - amber
      - amg2013
    # Bad variant +fftw
    # - aoflagger
      - athena
      - bowtie2
      - branson
      - camx
    # Bad variant +gpu
    # - candle-benchmarks
      - cbench
      - cgm
      - chatterbug
      - cistem
      - comd
    # old version of openmpi
    # - converge
    # bad variant tensor_ops=mpi
    # - cosmoflow-benchmark
      - cosmomc
      - cosp2
    # libxsmm not avail on arm
    # - cp2k
      - dock
      - elk
      - elmerfem
      - exabayes
      - examl
      - flecsph
      - frontistr
      - gatk
      - graph500
      - hpgmg
      - lammps
      - latte
      - macsio
      - meep
      - meme
      - modylas
      - mrbayes
      - mrchem
      - mxnet
      - nalu
      - nalu-wind
      - namd
      - nek5000
      - nekbone
      - nektar
      - nest
      - nut
      - nwchem
      - octopus
      - openmm
      - pathfinder
      - picsar
      - pism
      - qbox
      - qmcpack
      - quantum-espresso
      - relion
      - siesta
      - snbone
      - star
      - su2
      - swfft
      - tinker
      - vasp
      - vpfft
      - vpic
      - warpx
      - yambo

  mirrors:
    mirror: "s3://spack-binaries-develop/aws-ahug"

  specs:
  - matrix:
    - [$ahug_miniapps]
    - [$compilers]
  - matrix:
    - [$ahug_fullapps]
    - [$compilers]

  gitlab-ci:
  # bootstrap:
  #   - name: bootstrap-compilers
    image: { "name": "scottwittenburg/ubuntu18.04-runner:2021-06-14", "entrypoint": [""] }
    script:
      - . "./share/spack/setup-env.sh"
      - spack --version
      - cd ${SPACK_CONCRETE_ENV_DIR}
      - spack env activate --without-view .
      - spack config add "config:install_tree:projections:${SPACK_JOB_SPEC_PKG_NAME}:'morepadding/{architecture}/{compiler.name}-{compiler.version}/{name}-{version}-{hash}'"
      - spack -d ci rebuild
    mappings:
      - match: [ascent, axom, llvm, sundials, umpire, vtk-h, vtk-m]
        runner-attributes:
          tags: ["spack", "public", "xlarge", "graviton2"]
      - match: ['@:']
        runner-attributes:
          tags: ["spack", "public", "xlarge", "graviton2"]
    temporary-storage-url-prefix: "s3://spack-binaries-prs/pipeline-storage"
    service-job-attributes:
      before_script:
        - . "./share/spack/setup-env.sh"
        - spack --version
        - cd share/spack/gitlab/cloud_pipelines/stacks/aws-ahug
        - spack env activate --without-view .
      image: { "name": "scottwittenburg/ubuntu18.04-runner:2021-06-14", "entrypoint": [""] }
      #before_script:
      #  - . "./share/spack/setup-env.sh"
      #  - spack --version
      #  - cd share/spack/gitlab/cloud_pipelines/stacks/aws-ahug
      #  - spack env activate --without-view .
      tags: ["spack", "public", "xlarge", "graviton2"]

  cdash:
    build-group: AHUG ARM HPC User Group
    url: https://cdash.spack.io
    project: Spack Testing
    site: Cloud Gitlab Infrastructure
