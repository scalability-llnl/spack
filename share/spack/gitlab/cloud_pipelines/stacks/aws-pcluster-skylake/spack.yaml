spack:
  view: false

  definitions:

  - optimized_configs:
    # - gromacs
    # - lammps
    # - mpas-model
    # - openfoam
    - palace
    # - py-devito
    # - quantum-espresso
    # - wrf

  - optimized_libs:
    - mpich
    - openmpi

  specs:
  - $optimized_configs
  # - $optimized_libs

  mirrors: { "mirror": "s3://spack-binaries/develop/aws-pcluster-skylake" }

  ci:
    pipeline-gen:
    - build-job:
<<<<<<< HEAD
        image: { "name": "ghcr.io/spack/pcluster-amazonlinux-2:v2023-07-01", "entrypoint": [""] }
=======
        image: { "name": "ghcr.io/spack/pcluster-amazonlinux-2:pr-30", "entrypoint": [""] }
>>>>>>> 577fd2489d ([aws-pcluster-pipelines] Install compilers into spack store)
        before_script:
        - - . "./share/spack/setup-env.sh"
          - . /etc/profile.d/modules.sh
          - spack --version
          - spack arch
<<<<<<< HEAD
<<<<<<< HEAD
        # Use gcc from pre-installed spack store
        - - cp share/spack/gitlab/cloud_pipelines/configs/config.yaml etc/spack/
          - /bin/bash "${SPACK_ROOT}/share/spack/gitlab/cloud_pipelines/stacks/aws-pcluster-neoverse_n1/setup-pcluster.sh"
          - rm etc/spack/config.yaml
=======
<<<<<<< HEAD
        # Use gcc from local container buildcache
        - - spack buildcache rebuild-index /bootstrap/local-cache/
          - sed -i.bkp s/"spack install gcc"/"spack install --cache-only --reuse gcc"/ /bootstrap/postinstall.sh
          - spack mirror add local-cache /bootstrap/local-cache
          - spack gpg trust /bootstrap/public-key
          - diff /bootstrap/postinstall.sh /bootstrap/postinstall.sh.bkp || echo Done
        - - /bin/bash "${SPACK_ARTIFACTS_ROOT}/postinstall.sh" -fg
>>>>>>> 577fd2489d ([aws-pcluster-pipelines] Install compilers into spack store)
          - spack config --scope site add "packages:all:target:[${SPACK_TARGET_ARCH}]"
=======
=======
>>>>>>> f8b501efa6 (Cleanup rebase)
        # Use gcc from pre-installed spack store
        - - cp share/spack/gitlab/cloud_pipelines/configs/config.yaml etc/spack/
          - /bin/bash "${SPACK_ROOT}/share/spack/gitlab/cloud_pipelines/stacks/aws-pcluster-neoverse_n1/setup-pcluster.sh"
          - rm etc/spack/config.yaml
          - spack config --scope site add "packages:all:target:[${SPACK_TARGET_ARCH}]"
    - signing-job:
        before_script:
          # Do not distribute Intel & ARM binaries
          - - for i in $(aws s3 ls --recursive ${SPACK_REMOTE_MIRROR_OVERRIDE}/build_cache/ | grep intel-oneapi | awk '{print $4}' | sed -e 's?^.*build_cache/??g'); do aws s3 rm ${SPACK_REMOTE_MIRROR_OVERRIDE}/build_cache/$i; done
            - for i in $(aws s3 ls --recursive ${SPACK_REMOTE_MIRROR_OVERRIDE}/build_cache/ | grep armpl | awk '{print $4}' | sed -e 's?^.*build_cache/??g'); do aws s3 rm ${SPACK_REMOTE_MIRROR_OVERRIDE}/build_cache/$i; done
  cdash:
    build-group: AWS Packages
