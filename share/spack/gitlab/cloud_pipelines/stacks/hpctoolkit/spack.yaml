spack:
  view: false
  
  concretizer:
    reuse: false
    unify: false
    targets:
      granularity: generic
  
  config:
    concretizer: clingo
    install_tree:
      root: /home/software/spack
      padded_length: 512
      projections:
        all: '{architecture}/{compiler.name}-{compiler.version}/{name}-{version}-{hash}'

  definitions:
  - when: arch.satisfies('target=x86_64:')
    target:
    - target=x86_64_v3
  - when: arch.satisfies('target=aarch64:')
    target:
    - target=graviton
  
  - target_specific_mindeps: []
  - when: arch.satisfies('target=x86_64:')
    target_specific_mindeps:
    - ^intel-xed @12.0.1

  specs:
    - matrix:
      - - libmonitor +hpctoolkit ~dlopen ~commrank
      - ['@2021.11.08', '@:']
      - - $target
    # Latest release with latest compatible dependencies
    - matrix:
      - - hpctoolkit +mpi +viewer
      - [+papi, ~papi]
      - - $target
    # Latest release with minimum supported dependencies
    - matrix:
      - - hpctoolkit +mpi +viewer
      - - +papi ^papi @6.0.0.1
        - ~papi ^libpfm4 @4.11.0
      - - ^autoconf @2.69
          ^automake @1.15.1
          ^libtool @2.4.6
          ^boost @1.77.0
          ^libiberty @2.37
          ^elfutils @0.186
          ^dyninst @12.1.0
          ^intel-tbb @2020.3
          ^bzip2 @1.0.8
          ^xz @5.2.5
          ^zlib @1.2.12
          ^libunwind @1.6.2
          ^xerces-c @3.2.3
          ^memkind @1.12.0
      - - $target_specific_mindeps
      - - $target

  mirrors:
    mirror: s3://spack-binaries/develop/hpctoolkit
    develop: s3://spack-binaries/develop

  gitlab-ci:
    script:
      - . "./share/spack/setup-env.sh"
      - spack --version
      - cd ${SPACK_CONCRETE_ENV_DIR}
      - spack env activate --without-view .
      - spack config add "config:install_tree:projections:${SPACK_JOB_SPEC_PKG_NAME}:'morepadding/{architecture}/{compiler.name}-{compiler.version}/{name}-{version}-{hash}'"
      - if [[ -r /mnt/key/intermediate_ci_signing_key.gpg ]]; then spack gpg trust /mnt/key/intermediate_ci_signing_key.gpg; fi
      - if [[ -r /mnt/key/spack_public_key.gpg ]]; then spack gpg trust /mnt/key/spack_public_key.gpg; fi
      - spack -d ci rebuild
    
    variables:
      CI_JOB_SIZE: default

    mappings:
      - match: ['os=centos7 target=:x86_64_v3']
        runner-attributes:
          image: ghcr.io/blue42u/e4s-centos-7:latest@sha256:29dce475b2d2b3e040234d1993787f466cd3dc48c091a0c520cd794808c9ae2f
          tags: ["spack", "x86_64_v3"]
      - match: ['os=fedora36 target=:x86_64_v3']
        runner-attributes:
          image: ghcr.io/blue42u/e4s-fedora-36:latest@sha256:4dcda2b254311dd80996f9d5ca8e2dadffafbc91b10fb5c5f09f6efefa415afc
          tags: ["spack", "x86_64_v3"]
      - match: ['os=fedora36 target=:graviton']
        runner-attributes:
          image: ghcr.io/blue42u/e4s-fedora-36:latest@sha256:f2e92918b7541b4e78fe09ea3942d700cdbda1daabed9a1d18789c570e503fd8
          tags: ["spack", "graviton"]
      - match: ['os=opensuse_leap15 target=:x86_64_v3']
        runner-attributes:
          image: ghcr.io/blue42u/e4s-leap-15:latest@sha256:baabf6938a24962d9ee865c956f3061ea90f73a310b27d18d283e6ddc42c0cc3
          tags: ["spack", "x86_64_v3"]
      - match: ['os=almalinux8 target=:x86_64_v3']
        runner-attributes:
          image: ghcr.io/blue42u/e4s-almalinux-8:latest@sha256:82b63e63a3424f6bce9b7d8c2dbd0597d90f78afe3712e8e094fc10c44e116bc
          tags: ["spack", "x86_64_v3"]
      - match: ['os=almalinux8 target=:graviton']
        runner-attributes:
          image: ghcr.io/blue42u/e4s-almalinux-8:latest@sha256:1f5a5c4bfbd6023f9ddaa2450ef9f6a53a903a47d29b29dbd2e58390b43399e8
          tags: ["spack", "graviton"]
      - match: ['os=ubuntu20.04 target=:x86_64_v3']
        runner-attributes:
          image: ghcr.io/spack/e4s-ubuntu-20.04:v2022-03-21
          tags: ["spack", "x86_64_v3"]
      - match: ['os=ubuntu20.04 target=:graviton']
        runner-attributes:
          image: ghcr.io/spack/e4s-ubuntu-20.04:v2022-03-21
          tags: ["spack", "graviton"]

    broken-specs-url: "s3://spack-binaries/broken-specs"

    service-job-attributes:
      before_script:
        - . "./share/spack/setup-env.sh"
        - spack --version
      image: { "name": "ghcr.io/spack/ubuntu-jammy:latest", "entrypoint": [""] }
      tags: ["spack", "public", "x86_64_v3"]

    signing-job-attributes:
      image: { "name": "ghcr.io/spack/notary:latest", "entrypoint": [""] }
      tags: ["spack", "aws"]
      script:
        - aws s3 sync --exclude "*" --include "*spec.json*" ${SPACK_REMOTE_MIRROR_OVERRIDE}/build_cache /tmp
        - /sign.sh
        - aws s3 sync --exclude "*" --include "*spec.json.sig*" /tmp ${SPACK_REMOTE_MIRROR_OVERRIDE}/build_cache