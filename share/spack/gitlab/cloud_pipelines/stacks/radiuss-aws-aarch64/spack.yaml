spack:
  view: false

  concretizer:
    reuse: false
    unify: false

  config:
    concretizer: clingo
    install_tree:
      root: /home/software/spack
      padded_length: 384
      projections:
        all: '{architecture}/{compiler.name}-{compiler.version}/{name}-{version}-{hash}'

  packages:
    all:
      providers:
        blas:
          - openblas
        mkl:
          - intel-oneapi-mkl
        mpi:
          - openmpi
          - mpich
      variants: +mpi

  definitions:
  - radiuss:
    - ascent
    - blt
    - caliper
    - caliper +cuda cuda_arch=70
    - camp
    - camp +cuda
    - chai
    - chai +cuda +raja
    - mfem
    - mfem +superlu-dist+petsc+sundials
    - mfem +cuda cuda_arch=70 ^hypre+cuda
    - raja
    - raja +cuda cuda_arch=70
    - umpire
    - umpire +cuda

  - compiler:
    - '%gcc@7.3.1'

  - target:
    - 'target=aarch64'
    - 'target=graviton2'

  specs:

  - matrix:
    - - $radiuss
    - - $compiler
    - - $target

  mirrors: { "mirror": "s3://spack-binaries/develop/radiuss-aws-aarch64-abs-sonames-test" }

  gitlab-ci:

    script:
      - (cd "$(mktemp -d)" || exit 1; curl -LfsO https://github.com/NixOS/patchelf/releases/download/0.15.0/patchelf-0.15.0-aarch64.tar.gz; echo "03f8ad07dbd8fbdb5f47a9c168684be9d10b900a73b2df3f408fb0228e05fe6a  patchelf-0.15.0-aarch64.tar.gz" | sha256sum --check --quiet || exit 1; tar -xf patchelf-0.15.0-aarch64.tar.gz -C /usr; patchelf --version)
      - . "./share/spack/setup-env.sh"
      - spack --version
      - cd ${SPACK_CONCRETE_ENV_DIR}
      - spack env activate --without-view .
      - spack config add "config:install_tree:projections:${SPACK_JOB_SPEC_PKG_NAME}:'morepadding/{architecture}/{compiler.name}-{compiler.version}/{name}-{version}-{hash}'"
      - mkdir -p ${SPACK_ARTIFACTS_ROOT}/user_data
      - if [[ -r /mnt/key/intermediate_ci_signing_key.gpg ]]; then spack gpg trust /mnt/key/intermediate_ci_signing_key.gpg; fi
      - if [[ -r /mnt/key/spack_public_key.gpg ]]; then spack gpg trust /mnt/key/spack_public_key.gpg; fi
      - spack -d ci rebuild > >(tee ${SPACK_ARTIFACTS_ROOT}/user_data/pipeline_out.txt) 2> >(tee ${SPACK_ARTIFACTS_ROOT}/user_data/pipeline_err.txt >&2)

    image: { "name": "ghcr.io/spack/e4s-amazonlinux-2:v2022-03-21", "entrypoint": [""] }
    mappings:
      - match:
        - llvm
        - llvm-amdgpu
        - pango
        - paraview
        runner-attributes:
          tags: [ "spack", "huge", "aarch64" ]
          variables:
            CI_JOB_SIZE: huge
            KUBERNETES_CPU_REQUEST: 11000m
            KUBERNETES_MEMORY_REQUEST: 42G


      - match:
        - ascent
        - atk
        - axom
        - cistem
        - ctffind
        - cuda
        - dyninst
        - gcc
        - ginkgo
        - hdf5
        - hpx
        - kokkos-kernels
        - kokkos-nvcc-wrapper
        - magma
        - mfem
        - mpich
        - openturns
        - parallelio
        - precice
        - raja
        - relion
        - rocblas
        - rocsolver
        - rust
        - slate
        - strumpack
        - sundials
        - trilinos
        - umpire
        - vtk
        - vtk-h
        - vtk-m
        - warpx
        - wrf
        - wxwidgets
        runner-attributes:
          tags: [ "spack", "large", "aarch64" ]
          variables:
            CI_JOB_SIZE: large
            KUBERNETES_CPU_REQUEST: 8000m
            KUBERNETES_MEMORY_REQUEST: 12G

      - match: ['os=amzn2']
        runner-attributes:
          tags: ["spack", "aarch64"]
          variables:
            CI_JOB_SIZE: "default"

    broken-specs-url: "s3://spack-binaries/broken-specs"

    service-job-attributes:
      before_script:
        - . "./share/spack/setup-env.sh"
        - spack --version
      image: { "name": "ghcr.io/spack/e4s-amazonlinux-2:v2022-03-21", "entrypoint": [""] }
      tags: ["spack", "public", "aarch64"]

    signing-job-attributes:
      image: { "name": "ghcr.io/spack/notary:latest", "entrypoint": [""] }
      tags: ["spack", "aws"]
      script:
        - aws s3 sync --exclude "*" --include "*spec.json*" ${SPACK_REMOTE_MIRROR_OVERRIDE}/build_cache /tmp
        - /sign.sh
        - aws s3 sync --exclude "*" --include "*spec.json.sig*" /tmp ${SPACK_REMOTE_MIRROR_OVERRIDE}/build_cache

  cdash:
    build-group: RADIUSS AWS Packages
    url: https://cdash.spack.io
    project: Spack Testing
    site: Cloud Gitlab Infrastructure
